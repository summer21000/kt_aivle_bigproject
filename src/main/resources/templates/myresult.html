<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>분석 결과 및 평가 기록</title>
    <link rel="stylesheet" href="/css/myresult.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* “저장된 발표영상이 없습니다” 메시지 스타일 */
        .no-videos-message {
          text-align: center;
          color: #666666;
          margin: 20px 0;
          font-size: 1.2em;
        }
        /* 썸네일 컨테이너 – Flex 레이아웃으로 썸네일 개수와 상관없이 균일하게 보이도록 함 */
        .thumbnail-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
          position: relative; /* 내부에 오버레이(로딩, 완료 영상)를 배치하기 위함 */
        }
        /* 개별 썸네일 스타일 */
        .video-thumbnail {
          max-width: 300px;
          cursor: pointer;
          position: relative;
        }
        /* 로딩 오버레이 – “분석 중입니다...” 메시지 (썸네일 내부에 오버레이) */
        #loadingModal {
          display: none;
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
          color: #fff;
          text-align: center;
          padding-top: 50px;
          font-size: 24px;
          z-index: 10;
        }
        #loadingModal.active {
          display: block;
        }
        /* 평가 완료 영상 오버레이 */
        #completedVideoContainer {
          display: none;
          position: absolute;
          background-color: rgba(0,0,0,0.5);
          text-align: center;
          z-index: 10;
        }
        #completedVideoContainer.active {
          display: block;
        }

        .chart-container {
            background: #f9f9f9; /* 배경 흰색 */
<!--            padding: 15px; /* 내부 여백 추가 */-->
            border-radius: 8px; /* 둥근 모서리 적용 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* 부드러운 그림자 효과 */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* 부모 요소에 맞춤 */
            height: auto; /* 높이를 자동 조정 */
            min-height: 300px; /* 최소 높이 설정 */
        }
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .text-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .text-box {
            background: #f9f9f9;
            padding: 18px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: none;
        }

        /* 텍스트 스타일 개선 */
        .text-box p {
            font-size: 1rem;
            margin: 6px 0;
            color: #444;
        }

        .text-box strong {
            font-weight: bold;
            color: #333;
        }

        /* 점수 강조 */
        .text-box span {
            font-size: 1.2rem;
            font-weight: bold;
            color: #007bff;
        }

        /* 주요 감점 요인 스타일 */
        .modalFrequency {
            color: #dc3545 !important; /* 붉은색 강조 */
            font-weight: bold !important;
        }

        .modalFrequencyRatio {
            color: #28a745 !important; /* 초록색 강조 */
            font-weight: bold !important;
        }

        #timeLinks {
            display: block;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px; /* 간격 추가 */
            margin-top: 10px;
        }

        #timeLinks p {
            font-weight: bold;
            margin-right: 10px;
        }

        #timeLinks a {
            display: inline-block;
            padding: 6px 12px;
            text-decoration: none;
            background-color: #007bff;
            color: white;
            border-radius: 6px;
            font-size: 14px;
            transition: background-color 0.3s ease-in-out;
            margin-bottom: 10px;
        }

        #timeLinks a:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body class="myresult">
<!-- 네비게이션 (Thymeleaf include) -->
<div th:replace="navbar.html"></div>

<main>
    <section class="content">
        <div class="centered-content analysis-section">
            <h1 class="analysis-result">분석결과</h1>
            <div class="analysis-line"></div>
            <!-- 발표영상, 면접영상 선택 버튼 -->
            <div class="button-container">
                <button class="mui-button active-button" id="presentationVideoButton">발표영상</button>
                <button class="mui-button" id="interviewVideoButton">면접영상</button>
            </div>
        </div>

        <!-- 썸네일 컨테이너 (내부에 로딩/완료 오버레이 포함) -->
        <div class="thumbnail-container">
            <!-- 발표영상 섹션 -->
            <div id="presentationVideos">
                <div th:if="${presentationVideos == null or #lists.isEmpty(presentationVideos)}">
                    <h1 class="no-videos-message">저장된 발표영상이 없습니다.</h1>
                    <div class="video-flex" style="text-align: center; margin: 20px 0;">
                        <!--평가중-->
                        <div class="video-container"
                             id="completedVideoContainer"
                             th:if="${evaluatingScore != null and evaluatingScore['scoreId'] != null}">
                            <div class="video-container" >
                                <div class="video-thumbnail">
                                    <video id="completedVideo" width="300" height="180">
                                    </video>
                                    <div id="loadingModal">
                                        <p>분석 중입니다... 잠시만 기다려주세요.</p>
                                    </div>
                                </div>
                                <p><strong>날짜:</strong> <span th:text="${#temporals.format(evaluatingScore['date'], 'yyyy-MM-dd HH:mm')}"></span></p>
                                <p><strong>작성자:</strong> <span th:text="${evaluatingScore['userId']}"></span></p>
                            </div>
                        </div>

                        <div th:each="score : ${previousScores}" class="video-container">
                            <div th:if="${score.status != 'IN_PROGRESS'}" class="video-container">
                                <div class="video-thumbnail"
                                     th:attr="scoreId=${score.scoreId},
                                              totalscore=${score.totalScore},
                                              motionscore=${score.motionScore},
                                              expressionscore=${score.expressionScore},
                                              languagescore=${score.languageScore},
                                              textscript=${score.script},
                                              fileId=${score.fileId}"
                                     onclick="openScoreModal(this)">
                                    <video width="300" height="180"
                                           th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileId})}">
                                    </video>
                                </div>
                                <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>
                                <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 면접영상 섹션 -->
            <div id="interviewVideos">
                <div th:if="${interviewVideos == null or #lists.isEmpty(interviewVideos)}">
                    <h1 class="no-videos-message">저장된 면접영상이 없습니다.</h1>
                    <div class="video-flex" style="text-align: center; margin: 20px 0;">
                        <div th:each="score : ${previousScores2}" class="video-container">
                            <div th:if="${score.status != 'IN_PROGRESS'}" class="video-container">
                                <div class="video-thumbnail"
                                     th:attr="scoreId=${score.score2Id},
                                              totalscore=${score.totalScore},
                                              eyeheadscore=${score.eyeheadScore},
                                              expressionscore=${score.expressionScore},
                                              languagescore=${score.languageScore},
                                              textscript=${score.script},
                                              fileId=${score.fileId}"
                                     onclick="openScoreModal2(this)">
                                    <video width="300" height="180"
                                           th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileId})}">
                                    </video>
                                </div>
                                <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>
                                <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


<!--            <div id="interviewVideos" style="display: none;">-->
<!--                <div th:if="${interviewVideos != null and !#lists.isEmpty(interviewVideos)}">-->
<!--                    <div th:each="video, iterStat : ${interviewVideos}">-->
<!--                        <img th:if="${video.thumbnailUrl != null}"-->
<!--                             th:src="@{${video.thumbnailUrl}}"-->
<!--                             alt="면접영상 썸네일"-->
<!--                             th:attr="data-videoUrl=${video.videoUrl}"-->
<!--                             class="video-thumbnail" />-->
<!--                        <div th:if="${iterStat.index % 3 == 2}" style="clear: both;"></div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div th:if="${interviewVideos == null or #lists.isEmpty(interviewVideos)}">-->
<!--                    <h1 class="no-videos-message">저장된 면접영상이 없습니다.</h1>-->
<!--                    <div style="text-align: center; margin: 20px 0;">-->
<!--                        <div th:each="score : ${previousScores}" class="video-container">-->
<!--                            <div th:if="${score.status != 'IN_PROGRESS'}" class="video-container">-->
<!--                                <div class="video-thumbnail"-->
<!--                                     th:attr="totalscore=${score.totalScore}, motionscore=${score.motionScore}, fileId=${score.fileId}"-->
<!--                                     onclick="openScoreModal(this)">-->
<!--                                    <video width="350" height="230"-->
<!--                                           th:src="@{/myresults/upload/results/{fileId}(fileId=${score.fileId})}">-->
<!--                                    </video>-->
<!--                                </div>-->
<!--                                <p><strong>날짜:</strong> <span th:text="${#temporals.format(score.date, 'yyyy-MM-dd HH:mm')}"></span></p>-->
<!--                                <p><strong>작성자:</strong> <span th:text="${score.userId}"></span></p>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
        </div>

        <div class="spacer"></div>

        <!-- 분석 결과 모달 -->
        <div id="videoModal" class="modal" role="dialog" aria-modal="true">
            <div class="modala" tabindex="-1">
                <button class="modal-close" id="analysisModalClose" aria-label="Close analysis modal">&times;</button>
                <div class="module-titleArea">
                    <h1>분석 결과</h1>
                </div>
                <div class="menu-bar hidden" id="menuBar1">
                    <a href="#" id="summaryResult" class="active" >종합결과</a>
                    <a href="#" id="detailAnalysis" >세부분석</a>
                </div>
                <div class="menu-bar hidden" id="interviewmenuBar1">
                    <a href="#" id="summaryResult2" class="active" >종합결과</a>
                    <a href="#" id="detailAnalysis2" >세부분석</a>
                </div>
                <!-- 종합결과 -->
                <div id="summaryContent" class="summary-content">
                    <!-- 차트들을 나란히 배치하기 위한 래퍼 -->
                    <div class="chart-wrapper" style="display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap;">
                        <!-- 기존 진행률 차트 영역 (하위/상위 차트) -->
                        <div class="progress-container" style="flex: 1; min-width: 300px; margin: 10px;">
                            <!-- 점수 관련 내용 영역 -->
                            <div id="scoreSummary"></div>
                            <p class="rank-text"><strong id="rank-label"></strong> <span id="percent-value"></span>%</p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                                <div class="progress-marker"></div>
                            </div>
                            <p class="progress-description">전체 면접 영상 중 내 면접 영상의 순위</p>

                            <div class="chart-container">
                                <canvas id="totalChart"></canvas>
                            </div>
                        </div>

                        <div class="progress-container" style="flex: 1; min-width: 300px; margin: 10px;">
                            <!-- 추가한 레이더 차트 영역 -->
                            <div class="score-radar-chart" style="flex: 1; min-width: 300px; margin: 10px;">
                                <canvas id="radarChart"></canvas>
                            </div>
                            <div class="text-container">
                                <div class="text-box">
                                    <p><strong>점수:</strong> <span class="modalScore"></span>점</p>
                                </div>
                                <div class="text-box">
                                    <p><strong>주요 감점 항목 : </strong> <span class="modalFrequency"> </span></p>
                                    <p><strong>점수 :</strong> <span class="modalFrequencyRatio"></span>점</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 세부분석 -->
                <div id="detailContent" class="detail-content">
                    <div class="menu-bar hidden" id="menuBar2">
                        <a href="#" id="motion" class="active" >모션점수</a>
                        <a href="#" id="voice" >언어점수</a>
                        <a href="#" id="gaze" >표정점수</a>
                    </div>
                    <div class="menu-bar hidden" id="interviewmenuBar2">
                        <a href="#" id="eyehead" class="active" >시선점수</a>
                        <a href="#" id="voice2" >언어점수</a>
                        <a href="#" id="gaze2" >표정점수</a>
                    </div>
                    <div class="modal-body split">
                        <div class="modal-left">
                            <video controls id="analysisVideo">
                                Your browser does not support the video tag.
                            </video>
                            <div id="timeLinks"></div>


                        </div>
                        <div class="modal-right">
                            <div class="frame-card">
                                <div id="motionContent" class="motion-content active">
                                    <div class="text-container">
                                        <div class="text-box">
                                            <p><strong>점수:</strong> <span class="modalScore"></span>점</p>
                                        </div>
                                        <div class="text-box">
                                            <p><strong>주요 감점 요인 : </strong> <span class="modalFrequency"> </span></p>
                                            <p><strong>주요 감점 요인 비율 :</strong> <span class="modalFrequencyRatio"></span>%</p>
                                        </div>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="motionChart"></canvas>
                                    </div>
                                </div>
                                <div id="voiceContent" class="voice-content">
                                    <div class="text-container">
                                        <div class="text-box">
                                            <p><strong>점수:</strong> <span class="modalScore"></span>점</p>
                                        </div>
                                        <div class="text-box">
                                            <p><strong>주요 감점 요인 : </strong> <span class="modalFrequency"> </span></p>
                                            <p><strong>주요 감점 요인 비율 :</strong> <span class="modalFrequencyRatio"></span>%</p>
                                        </div>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="languageChart"></canvas>
                                    </div>
                                </div>
                                <div id="gazeContent" class="gaze-content">
                                    <div class="text-container">
                                        <div class="text-box">
                                            <p><strong>점수:</strong> <span class="modalScore"></span>점</p>
                                        </div>
                                        <div class="text-box">
                                            <p><strong>주요 감점 요인 : </strong> <span class="modalFrequency"> </span></p>
                                            <p><strong>주요 감점 요인 비율 :</strong> <span class="modalFrequencyRatio"></span>%</p>
                                        </div>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="expressionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <!-- 평가 기록 영역 (백엔드 담당 코드) -->
    <!-- 기존 평가 기록 영역은 주석 처리되어 있음 -->
</main>


<div th:replace="footer.html"></div>

<!-- 외부 Chart.js 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- 스크립트 (분석 결과 및 평가 기록 영역 기능 포함) -->
<script>
    /***** 분석 결과 영역 (프론트엔드) *****/
    const analysisModal = document.getElementById('videoModal');
    const summaryContent = document.getElementById('summaryContent');
    const detailContent = document.getElementById('detailContent');
    const menuBar1 = document.getElementById('menuBar1');
    const menuBar2 = document.getElementById('menuBar2');
    const interviewmenuBar1 = document.getElementById('interviewmenuBar1');
    const interviewmenuBar2 = document.getElementById('interviewmenuBar2');
    const detailAnalysis = document.getElementById('detailAnalysis');
    const detailAnalysis2 = document.getElementById('detailAnalysis2');
    const summaryResult = document.getElementById('summaryResult');
    const summaryResult2 = document.getElementById('summaryResult2');
    const analysisModalClose = document.getElementById('analysisModalClose');
    const motionButton = document.getElementById('motion');
    const voiceButton = document.getElementById('voice');
    const gazeButton = document.getElementById('gaze');
    const eyeheadButton = document.getElementById('eyehead');
    const voiceButton2 = document.getElementById('voice2');
    const gazeButton2 = document.getElementById('gaze2');
    const motionContent = document.getElementById('motionContent');
    const voiceContent = document.getElementById('voiceContent');
    const gazeContent = document.getElementById('gazeContent');
    const analysisVideo = document.getElementById('analysisVideo');
    const presentationVideoButton = document.getElementById('presentationVideoButton');
    const interviewVideoButton = document.getElementById('interviewVideoButton');
    presentationVideoButton.classList.add('active-button');
    presentationVideos.style.display = 'block';
    interviewVideos.style.display = 'none';
    let chartInstance = null;

    presentationVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'block';
      interviewVideos.style.display = 'none';
      presentationVideoButton.classList.add('active-button');
      interviewVideoButton.classList.remove('active-button');
    });

    interviewVideoButton.addEventListener('click', () => {
      presentationVideos.style.display = 'none';
      interviewVideos.style.display = 'block';
      interviewVideoButton.classList.add('active-button');
      presentationVideoButton.classList.remove('active-button');
    });

    /***** 폴링 및 로딩/완료 오버레이 업데이트 *****/
    let pollingInterval = null;

    function pollEvaluatingScore() {
      fetch('/scores/results/api')
        .then(res => res.json())
        .then(data => {
          const evalScore = data.evaluatingScore;
          const loadingModal = document.getElementById('loadingModal');
          const completedVideoContainer = document.getElementById('completedVideoContainer');
          const completedVideo = document.getElementById('completedVideo');

          if (!evalScore || Object.keys(evalScore).length === 0) {
            if (loadingModal && loadingModal.classList.contains("active")) {
                loadingModal.classList.remove("active");
            }

            if (completedVideoContainer && completedVideoContainer.classList.contains("active")) {
                completedVideoContainer.classList.remove("active");
                updatePreviousScores(data.previousScores);
            }

            clearInterval(pollingInterval);
            pollingInterval = null;
            return;
          }else{
            loadingModal.classList.add('active');
            completedVideoContainer.classList.add('active');
            completedVideo.src = '/myresults/upload/results/' + evalScore.fileId;
          }
        })
        .catch(err => console.error('Error in polling:', err));
    }
    document.addEventListener('DOMContentLoaded', () => {
      if (pollingInterval === null) {
        pollingInterval = setInterval(pollEvaluatingScore, 3000);
      }
    });

    function updatePreviousScores(scores) {
        const container = document.querySelector('.video-flex');
        const previousScoresDivs = container.querySelectorAll('.video-container:not(#completedVideoContainer)');

        // 기존 previousScores 비우기
        previousScoresDivs.forEach(div => div.remove());

        scores.forEach(score => {
            if (score.status !== 'IN_PROGRESS') {
                const videoContainer = document.createElement('div');
                videoContainer.classList.add('video-container');

                videoContainer.innerHTML = `
                    <div class="video-container">
                        <div class="video-thumbnail"
                             scoreId="${score.scoreId}"
                             totalscore="${score.totalScore}"
                             motionscore="${score.motionScore}"
                             expressionscore="${score.expressionScore}"
                             languagescore="${score.languageScore}"
                             textscript="${score.script}"
                             fileId="${score.fileId}"
                             onclick="openScoreModal(this)">
                            <video width="300" height="180" src="/myresults/upload/results/${score.fileId}"></video>
                        </div>
                        <p><strong>날짜:</strong> ${new Date(score.date).toLocaleString()}</p>
                        <p><strong>작성자:</strong> ${score.userId}</p>
                    </div>
                `;
                container.appendChild(videoContainer);
            }
        });
    }

    // updateSummaryContent() 함수: 점수 정보를 출력한 후 진행률 및 레이더 차트를 업데이트합니다.
    function updateSummaryContent(totalScore, motionScore, expressionScore, languageScore, percentile) {
        let summaryText =
            '<h2>총 점수 ' + totalScore + '</h2>'
        document.getElementById("scoreSummary").innerHTML = summaryText;
        updateProgress(percentile);
        // 레이더 차트 업데이트: 점수값을 숫자로 변환하여 전달
        renderRadarChart(Number(motionScore), Number(expressionScore), Number(languageScore));
        updateChart('total',totalScore)
    }

    // 면접용 모달내용 변환
    function updateSummaryContent2(totalScore, eyeheadscore, expressionScore, languageScore, percentile) {
        let summaryText =
            '<h2>총 점수 ' + totalScore + '</h2>'
        document.getElementById("scoreSummary").innerHTML = summaryText;
        updateProgress(percentile);
        // 레이더 차트 업데이트: 점수값을 숫자로 변환하여 전달
        renderRadarChart(Number(eyeheadscore), Number(expressionScore), Number(languageScore));
        updateChart2('total',totalScore)
    }

    //발표용 버튼
    //세부분석
    detailAnalysis.addEventListener('click', function(event) {

      const motionScore = event.target.getAttribute('data-score');
      const scoreId = event.target.getAttribute('data-scoreId');

      event.preventDefault();
      summaryContent.style.display = 'none';
      detailContent.style.display = 'block';
      menuBar2.classList.remove('hidden');
      summaryResult.classList.remove('active');
      detailAnalysis.classList.add('active');
      activateTab(motionButton, motionContent);

      updateChart('motion',Number(motionScore).toFixed(1))
      updateModalContent("motion")
      updateTimes('motion', Number(motionScore).toFixed(1), scoreId)
    });

    // 종합결과 버튼
    summaryResult.addEventListener('click', function(event) {

      const totalScore = event.target.getAttribute('data-score');

      event.preventDefault();
      resetToSummary();
      updateChart('total',Number(totalScore).toFixed(1))
      updateModalContent("total")
    });

    function resetToSummary() {
      summaryContent.style.display = 'block';
      detailContent.style.display = 'none';
      menuBar2.classList.add('hidden');
      detailAnalysis.classList.remove('active');
      summaryResult.classList.add('active');
    }

    motionButton.addEventListener('click', function(event) {
      event.preventDefault();
      const motionScore = event.target.getAttribute('data-score');
      const scoreId = event.target.getAttribute('data-scoreId');

      activateTab(motionButton, motionContent);

      updateChart('motion',Number(motionScore).toFixed(1))
      updateModalContent("motion");
      updateTimes('motion', Number(motionScore).toFixed(1), scoreId)
    });

    voiceButton.addEventListener('click', function(event) {
      event.preventDefault();
      const languageScore = event.target.getAttribute('data-score');
      const timeLinksContainer = document.getElementById("timeLinks");
<!--      const script = event.target.getAttribute('data-script');-->

      activateTab(voiceButton, voiceContent);

      updateChart('language',Number(languageScore).toFixed(1))
      updateModalContent("language");

      timeLinksContainer.innerHTML = "";

    });

    gazeButton.addEventListener('click', function(event) {
      event.preventDefault();
      const expressionScore = event.target.getAttribute('data-score');
      const scoreId = event.target.getAttribute('data-scoreId');

      activateTab(gazeButton, gazeContent);

      updateChart('expression',Number(expressionScore).toFixed(1))
      updateModalContent("expression");
      updateTimes('expression', Number(expressionScore).toFixed(1), scoreId)
    });

    function activateTab(button, content) {
      motionButton.classList.remove('active');
      voiceButton.classList.remove('active');
      gazeButton.classList.remove('active');
      motionContent.classList.remove('active');
      voiceContent.classList.remove('active');
      gazeContent.classList.remove('active');
      button.classList.add('active');
      content.classList.add('active');
    }

    // 면접용 버튼 정의
    // 세부분석버튼
    detailAnalysis2.addEventListener('click', function(event) {

      const eyeheadScore = event.target.getAttribute('data-score');
      const scoreId = event.target.getAttribute('data-scoreId');

      event.preventDefault();
      summaryContent.style.display = 'none';
      detailContent.style.display = 'block';
      interviewmenuBar2.classList.remove('hidden');
      summaryResult2.classList.remove('active');
      detailAnalysis2.classList.add('active');
      activateTab(eyeheadButton, motionContent);

      updateChart2('eyehead',Number(eyeheadScore).toFixed(1))
      updateModalContent("eyehead")
    });

    // 종합결과버튼
    summaryResult2.addEventListener('click', function(event) {
      const totalScore = event.target.getAttribute('data-score');
      event.preventDefault();
      resetToSummary2();
      updateChart2('total',Number(totalScore).toFixed(1))
      updateModalContent("total")
    });

    function resetToSummary2() {
      summaryContent.style.display = 'block';
      detailContent.style.display = 'none';
      interviewmenuBar2.classList.add('hidden');
      detailAnalysis2.classList.remove('active');
      summaryResult2.classList.add('active');
    }
    //시선분석 버튼
    eyeheadButton.addEventListener('click', function(event) {
      event.preventDefault();
      const eyeheadScore = event.target.getAttribute('data-score');
      const scoreId = event.target.getAttribute('data-scoreId');

      activateTab2(eyeheadButton, motionContent);

      updateChart2('eyehead',Number(eyeheadScore).toFixed(1))
      updateModalContent("eyehead");
    });

    // 언어분석 버튼
    voiceButton2.addEventListener('click', function(event) {
      event.preventDefault();
      const languageScore = event.target.getAttribute('data-score');
      const timeLinksContainer = document.getElementById("timeLinks");

      activateTab2(voiceButton2, voiceContent);

      updateChart2('language',Number(languageScore).toFixed(1))
      updateModalContent("language");

    });

    //표정분석 버튼
    gazeButton2.addEventListener('click', function(event) {
      event.preventDefault();
      const expressionScore = event.target.getAttribute('data-score');
      const scoreId = event.target.getAttribute('data-scoreId');

      activateTab2(gazeButton2, gazeContent);

      updateChart2('expression',Number(expressionScore).toFixed(1))
      updateModalContent("expression");
    });

    function activateTab2(button, content) {
      eyeheadButton.classList.remove('active');
      voiceButton2.classList.remove('active');
      gazeButton2.classList.remove('active');
      motionContent.classList.remove('active');
      voiceContent.classList.remove('active');
      gazeContent.classList.remove('active');
      button.classList.add('active');
      content.classList.add('active');
    }



    analysisModalClose.addEventListener('click', () => {
      closeAnalysisModal();
    });
    analysisModal.addEventListener('click', (event) => {
      if (event.target === analysisModal) {
        closeAnalysisModal();
      }
    });
    function closeAnalysisModal() {
      analysisModal.style.display = 'none';
      resetToSummary();
      resetToSummary2();
      analysisVideo.pause();
      analysisVideo.src = '';
    }

    /***** 평가 기록 영역 (백엔드) *****/
    function openScoreModal(element) {
      const totalscore = element.getAttribute('totalscore');
      const motionscore = element.getAttribute('motionscore');
      const expressionscore = element.getAttribute('expressionscore');
      const languagescore = element.getAttribute('languagescore');
      const scoreId = element.getAttribute('scoreId');
      const fileId = element.getAttribute('fileId');

      document.getElementById("summaryResult").setAttribute("data-score", totalscore);

      document.getElementById("detailAnalysis").setAttribute("data-score", motionscore);
      document.getElementById("detailAnalysis").setAttribute("data-scoreId", scoreId);

      document.getElementById("motion").setAttribute("data-score", motionscore);
      document.getElementById("motion").setAttribute("data-scoreId", scoreId);

      document.getElementById("voice").setAttribute("data-score", languagescore);

      document.getElementById("gaze").setAttribute("data-score", expressionscore);
      document.getElementById("gaze").setAttribute("data-scoreId", scoreId);

      $(".text-box").css("display", "block");
      menuBar1.classList.remove('hidden');
      interviewmenuBar1.classList.add('hidden');

      const videoElement = document.getElementById('analysisVideo');
      if (videoElement) {
        videoElement.src = `/myresults/upload/results/${fileId}`;
        videoElement.load();
      }
      fetch(`/scores/distribution?totalscore=${totalscore}`)
        .then(response => response.json())
        .then(percentile => {
            updateSummaryContent(Number(totalscore).toFixed(1), motionscore, expressionscore, languagescore, percentile);
        })
        .catch(error => {
            console.error('데이터 로드 실패:', error);
            alert('평가 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
        });

      $.ajax({
        url: "/scores/details2",
        type: "GET",
        data: { scoreId: scoreId },
        dataType: "json",
        success: function (data) {
            currentData = data;
            updateModalContent("total");
        },
        error: function () {
            alert("점수 데이터를 불러오는 데 실패했습니다.");
        }
      });



      analysisModal.style.display = 'block';
      resetToSummary();
    }

    /***** 면접 모달 열기 *****/
    function openScoreModal2(element) {
      const totalscore = element.getAttribute('totalscore');
      const eyeheadscore = element.getAttribute('eyeheadscore');
      const expressionscore = element.getAttribute('expressionscore');
      const languagescore = element.getAttribute('languagescore');
      const scoreId = element.getAttribute('scoreId');
      const fileId = element.getAttribute('fileId');

      document.getElementById("summaryResult2").setAttribute("data-score", totalscore);

      document.getElementById("detailAnalysis2").setAttribute("data-score", eyeheadscore);
      document.getElementById("detailAnalysis2").setAttribute("data-scoreId", scoreId);

      document.getElementById("eyehead").setAttribute("data-score", eyeheadscore);
      document.getElementById("eyehead").setAttribute("data-scoreId", scoreId);

      document.getElementById("voice2").setAttribute("data-score", languagescore);

      document.getElementById("gaze2").setAttribute("data-score", expressionscore);
      document.getElementById("gaze2").setAttribute("data-scoreId", scoreId);

      $(".text-box").css("display", "block");
      interviewmenuBar1.classList.remove('hidden');
      menuBar1.classList.add('hidden');

      const videoElement = document.getElementById('analysisVideo');
      if (videoElement) {
        videoElement.src = `/myresults/upload/results/${fileId}`;
        videoElement.load();
      }
      fetch(`/scores2/distribution?totalscore=${totalscore}`)
        .then(response => response.json())
        .then(percentile => {
            updateSummaryContent2(Number(totalscore).toFixed(1), eyeheadscore, expressionscore, languagescore, percentile);
        })
        .catch(error => {
            console.error('데이터 로드 실패:', error);
            alert('평가 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.');
        });

      $.ajax({
        url: "/scores2/details2",
        type: "GET",
        data: { score2Id: scoreId },
        dataType: "json",
        success: function (data) {
            currentData = data;
            updateModalContent("total");
        },
        error: function () {
            alert("점수 데이터를 불러오는 데 실패했습니다.");
        }
      });



      analysisModal.style.display = 'block';
      resetToSummary();
    }

    function displayTimes(elementId, timesMap) {
      const listElement = document.getElementById(elementId);
      listElement.innerHTML = '';
      Object.entries(timesMap).forEach(([actionName, timeList]) => {
        if (timeList.length > 0) {
          timeList.forEach(time => {
            const li = document.createElement('li');
            li.textContent = `${actionName}: ${time}초`;
            listElement.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = `${actionName}: 없음`;
          listElement.appendChild(li);
        }
      });
    }
    const scoreModalClose = document.getElementById('scoreModalClose');
    scoreModalClose.addEventListener('click', closeScoreModal);
    const commonModal = document.getElementById('commonModal');
    commonModal.addEventListener('click', (event) => {
      if (event.target === commonModal) {
        closeScoreModal();
      }
    });
    function closeScoreModal() {
      commonModal.classList.remove('active');
      document.getElementById('modalVideo').src = '';
    }
<!--상위, 하위 바그래프-->
    function updateProgress(percentile) {
      const progressFill = document.getElementById("progress-fill");
      const progressMarker = document.querySelector(".progress-marker");
      const rankLabel = document.getElementById("rank-label");
      const percentValue = document.getElementById("percent-value");

      // 퍼센트 값을 설정
      if (percentile >= 50) {
          percentValue.textContent = `${(100 - percentile).toFixed(1)}`;  // 상위 퍼센트
      } else {
          percentValue.textContent = `${percentile.toFixed(1)}`;  // 하위 퍼센트
      }

      // 막대의 위치 업데이트 (왼쪽->오른쪽 진행)
      let position = percentile + "%";
      progressFill.style.width = position;
      progressMarker.style.left = position;

      // 상위 / 하위 텍스트 변경
      if (percentile >= 50) {
          rankLabel.textContent = "상위";
      } else {
          rankLabel.textContent = "하위";
      }
    }

    /***** 추가: 레이더 차트 렌더링 함수 *****/
    function renderRadarChart(motionScore, expressionScore, languageScore) {
      const ctx = document.getElementById('radarChart').getContext('2d');

      // 기존 인스턴스가 있다면 제거하여 중복 방지
      if (window.radarChartInstance) {
        window.radarChartInstance.destroy();
      }

      window.radarChartInstance = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['모션 점수', '표정 점수', '언어 점수'],
          datasets: [{
            label: '점수',
            data: [motionScore, expressionScore, languageScore],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            r: {
              min: 0,       // 최소값 0
              max: 100,     // 최대값 100
              ticks: {
                stepSize: 20,   // 0, 20, 40, 60, 80, 100 으로 값 고정
                callback: function(value) {
                  return value;  // 각 tick의 값을 그대로 표시
                }
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function updateTimes(scoreType, score, scoreId) {
        let frequencyValue = currentData[`${scoreType}Frequency`] || "없음";
        const timeLinksContainer = document.getElementById("timeLinks");

        console.log("updateTimes 실행됨 - scoreType:", scoreType, "score:", score);

        timeLinksContainer.innerHTML = "";

        if(score<100){
            $.ajax({
                url: "/scores/times",
                type: "GET",
                dataType: "json",
                data: {
                    scoreType: scoreType,
                    scoreId: scoreId,
                    frequencyValue: frequencyValue
                },
                success: function (times) {
                    const title = document.createElement("p");
                    title.innerHTML = `<strong>감점시간</strong>`;
                    timeLinksContainer.appendChild(title);

                    times.forEach(time => {
                        const link = document.createElement("a");
                        link.href = "#";
                        link.innerText = ` ${time.toFixed(1)}초 `;
                        link.style.marginRight = "10px";
                        link.onclick = (event) => {
                            event.preventDefault();
                            document.getElementById("analysisVideo").currentTime = time;
                        };
                        timeLinksContainer.appendChild(link);
                    });

                }
            });
        }

    }


    function updateModalContent(scoreType) {
        let scoreValue = Math.round(currentData[`${scoreType}Score`]) || "없음";
        let frequencyValue = currentData[`${scoreType}Frequency`] || "없음";
        let frequencyRatioValue = Math.round(currentData[`${scoreType}FrequencyRatio`]) || "없음";

        $(".modalScore").text(scoreValue);
        $(".modalFrequencyRatio").text(frequencyRatioValue);

        if (scoreType == "total") {
            if (frequencyValue == "language") {
                $(".modalFrequency").text("언어점수");
            } else if (frequencyValue == "motion") {
                $(".modalFrequency").text("모션점수");
            } else if (frequencyValue == "expression") {
                $(".modalFrequency").text("표정점수");
            } else if (frequencyValue == "eyehead") {
                $(".modalFrequency").text("시선점수");
            }
        } else {
            if(scoreValue == 100){
                if (scoreType == "motion") {
                    $(".motion-content > div.text-container > div:nth-child(2)").css("display", "none");
                } else if (scoreType == "expression") {
                    $(".gaze-content > div.text-container > div:nth-child(2)").css("display", "none");
                } else if (scoreType == "language") {
                    $(".voice-content > div.text-container > div:nth-child(2)").css("display", "none");
                } else if (scoreType == "eyehead") {
                    $(".motion-content > div.text-container > div:nth-child(2)").css("display", "none");
                }
            }else{
                let transValue = frequencyValue;
                if (scoreType == "motion") {
                    const motionMapping = {
                        "handtohead": "머리 만지기",
                        "handup": "의미없는 팔동작",
                        "bodyscratching": "몸 긁기",
                        "nailtouching": "손톱만지기",
                        "swaying": "몸 흔들기",
                        "twisting": "몸 꼬기",
                        "headdown": "머리 숙이기",
                        "handsbehind": "뒷짐 지기"
                    };
                    translatedValue = motionMapping[frequencyValue] || frequencyValue;
                } else if (scoreType == "language") {
                    const languageMapping = {
                        "FIL-B": "간투어(의미없는 발성)",
                        "REP-B": "반복수정",
                        "PS-B": "휴지(긴 쉼)",
                        "WR-B": "발음오류"
                    };
                    translatedValue = languageMapping[frequencyValue] || frequencyValue;
                } else if (scoreType == "expression") {
                    const expressionMapping = {
                        "angry": "화난 표정",
                        "disgust": "찡그린 표정",
                        "fear": "두려운 표정",
                        "surprise": "놀란 표정"
                    };
                    translatedValue = expressionMapping[frequencyValue] || frequencyValue;
                } else if (scoreType == "eyehead") {
                    $(".motion-content > div.text-container > div:nth-child(2)").css("display", "none");
                }
                $(".modalFrequency").text(translatedValue);
            }
        }
    }

    function updateChart(scoreType, score) {
        let canvas = document.getElementById(`${scoreType}Chart`).getContext("2d");

        console.log("updateChart 실행됨 - scoreType:", scoreType, "score:", score);

        if (chartInstance) {
            console.log("기존 차트 삭제");
            chartInstance.destroy();
        }

        $.ajax({
            url: "/scores/all",
            type: "GET",
            dataType: "json",
            success: function (scores) {
                let scoreValues = scores.map(s => Math.round(s[`${scoreType}Score`]));

                let maxScore = scoreType === "total" ? 300 : 100;
                let labels = Array.from({ length: (maxScore / 5) + 1 }, (_, i) => i * 5);
                if (!labels.includes(maxScore)) labels.push(maxScore);

                let binnedScores = labels.reduce((acc, label) => {
                    acc[label] = 0;
                    return acc;
                }, {});

                scoreValues.forEach(score => {
                    let bin = Math.round(score / 5) * 5;
                    if (bin > maxScore) bin = maxScore;
                    binnedScores[bin]++;
                });


                let highlightedValue = Math.round(score / 5) * 5;

                chartInstance = new Chart(canvas, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: scoreType.toUpperCase() + " Score",
                            data: labels.map(label => binnedScores[label] || 0),
                            backgroundColor: labels.map(label => (label === highlightedValue ? "red" : "rgba(54, 162, 235, 0.5)")),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: "category" },
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        });
    }

    function updateChart2(scoreType, score) {
        let canvas
        if (scoreType == 'eyehead'){
            canvas = document.getElementById(`motionChart`).getContext("2d");
        }else{
            canvas = document.getElementById(`${scoreType}Chart`).getContext("2d");
        }

        console.log("updateChart 실행됨 - scoreType:", scoreType, "score:", score);

        if (chartInstance) {
            console.log("기존 차트 삭제");
            chartInstance.destroy();
        }

        $.ajax({
            url: "/scores2/all",
            type: "GET",
            dataType: "json",
            success: function (scores) {
                let scoreValues = scores.map(s => Math.round(s[`${scoreType}Score`]));

                let maxScore = scoreType === "total" ? 300 : 100;
                let labels = Array.from({ length: (maxScore / 5) + 1 }, (_, i) => i * 5);
                if (!labels.includes(maxScore)) labels.push(maxScore);

                let binnedScores = labels.reduce((acc, label) => {
                    acc[label] = 0;
                    return acc;
                }, {});

                scoreValues.forEach(score => {
                    let bin = Math.round(score / 5) * 5;
                    if (bin > maxScore) bin = maxScore;
                    binnedScores[bin]++;
                });


                let highlightedValue = Math.round(score / 5) * 5;

                chartInstance = new Chart(canvas, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: scoreType.toUpperCase() + " Score",
                            data: labels.map(label => binnedScores[label] || 0),
                            backgroundColor: labels.map(label => (label === highlightedValue ? "red" : "rgba(54, 162, 235, 0.5)")),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: "category" },
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        });
    }

</script>

<!-- 추가 스크립트: 썸네일이 있으면 '저장된 발표영상이 없습니다' 메시지 숨기기 -->
<script>
    document.addEventListener("DOMContentLoaded", function(){
      const presentationSection = document.getElementById("presentationVideos");
      const thumbnails = presentationSection.querySelectorAll(".video-thumbnail");
      if(thumbnails.length > 0){
        const noVideosMsg = presentationSection.querySelector(".no-videos-message");
        if(noVideosMsg){
          noVideosMsg.style.display = "none";
        }
      }
      const interviewSection = document.getElementById("interviewVideos");
      const thumbnails2 = interviewSection.querySelectorAll(".video-thumbnail");
      if(thumbnails2.length > 0){
        const noVideosMsg2 = interviewSection.querySelector(".no-videos-message");
        if(noVideosMsg2){
          noVideosMsg2.style.display = "none";
        }
      }
    });
</script>


</body>
</html>
